import mysql.connector
from mysql.connector import Error
import pandas as pd

# --- CONFIGURAÇÃO DE CONEXÃO ---
# Baseado nas suas imagens:
HOST_NAME = '127.0.0.1' 
USER_NAME = 'root'      
PASSWORD = ''           # Mantenha vazio '' se não houver senha no seu MySQL local
DATABASE_NAME = 'orcamento_rede' 

def gerar_relatorio_orcamento():
    conexao = None
    try:
        # Tenta estabelecer a conexão
        conexao = mysql.connector.connect(
            host=HOST_NAME,
            database=DATABASE_NAME,
            user=USER_NAME,
            password=PASSWORD
        )

        if conexao.is_connected():
            print("Conexão estabelecida com sucesso. Gerando relatório...")
            
            # Consulta SQL para buscar os dados e calcular o Custo Total de cada item
            consulta_sql = """
            SELECT 
                DESCRICAO, 
                ESPECIFICACAO, 
                QUANTIDADE, 
                PRECO_UNITARIO, 
                (QUANTIDADE * PRECO_UNITARIO) AS CUSTO_TOTAL_ITEM
            FROM orcamento_rede;
            """
            
            # 1. Lê o resultado da consulta SQL para um DataFrame do Pandas
            df = pd.read_sql(consulta_sql, conexao)
            
            # --- Cálculo Final e Preparação ---
            
            # 2. Calcula o custo total geral do projeto
            custo_total_projeto = df['CUSTO_TOTAL_ITEM'].sum()
            
            # 3. Adiciona uma linha de total ao final do relatório
            linha_total = pd.DataFrame([['CUSTO TOTAL DO PROJETO', '', '', '', custo_total_projeto]],
                                       columns=df.columns)
            df_final = pd.concat([df, linha_total], ignore_index=True)
            
            # --- Exportar para Excel ---
            nome_arquivo = 'Orcamento_Rede_Relatorio_Final.xlsx'
            df_final.to_excel(nome_arquivo, index=False, sheet_name='Orçamento de Rede')
            
            print(f"\n✅ Relatório gerado com sucesso!")
            print(f"O arquivo '{nome_arquivo}' foi criado na pasta do projeto.")
            print(f"Custo Total Geral: R$ {custo_total_projeto:.2f}")

    except Error as e:
        print(f"Erro ao conectar, processar ou gerar o relatório. Verifique se o MySQL está ligado e se as bibliotecas estão instaladas: {e}")

    finally:
        if conexao is not None and conexao.is_connected():
            conexao.close()
            print("Conexão com o banco de dados encerrada.")

if __name__ == "__main__":
    gerar_relatorio_orcamento()